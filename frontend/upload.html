<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Assignments</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px}
    main{padding:16px;display:flex;gap:16px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.08)}
    .col{flex:1}
    .badge{padding:2px 8px;border-radius:999px;background:#efefef;font-size:12px}
    table{border-collapse:collapse}
    td, th{border:1px solid #ddd;padding:6px 8px}
    .muted{color:#666}
    footer{padding:16px}
  </style>
</head>
<body>
  <header>
    <strong>Assignment Uploader</strong>
    <span class="muted">Step 1 of 2</span>
    <a href="/viewer" class="badge">Go to Viewer</a>
  </header>
  <main>
    <div class="col card">
      <h3>Select Assignment</h3>
      <div>
        <label>Assignment ID</label>
        <select id="setSelect"></select>
        <button id="refreshSets">Refresh</button>
      </div>
      <div style="margin-top:12px">
        <label>Jobs CSV <input type="file" id="jobsFile" accept=".csv"/></label>
        <label style="margin-left:8px">Vehicles CSV <input type="file" id="vehiclesFile" accept=".csv"/></label>
        <button id="uploadBtn">Upload</button>
      </div>
      <div style="margin-top:12px">
        <button id="openViewer">Open Viewer for Assignment</button>
      </div>
    </div>
    <div class="col card">
      <h3>CSV Previews</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <div class="badge" style="margin-bottom:4px">Jobs</div>
          <div id="jobsPreview" style="max-height:240px;overflow:auto"></div>
        </div>
        <div style="flex:1">
          <div class="badge" style="margin-bottom:4px">Vehicles</div>
          <div id="vehiclesPreview" style="max-height:240px;overflow:auto"></div>
        </div>
      </div>
    </div>
    <div class="col card">
      <h3>Detected Files in Set</h3>
      <div id="setInfo" class="muted">â€”</div>
    </div>
  </main>
  <footer class="muted">After uploading, proceed to Viewer to inspect points and optimize route.</footer>
  <script>
  async function loadSets(){
    const sel = document.getElementById('setSelect');
    sel.innerHTML = '';
    const j = await fetch('/api/mock-sets').then(r=>r.json());
    const arr = ((j.sets||[]).map(s=>s.id)).sort((a,b)=>a-b);
    for(const id of arr){
      const o = document.createElement('option'); o.value = String(id); o.textContent = String(id); sel.appendChild(o);
    }
    const saved = localStorage.getItem('TT_SET_ID');
    if(saved && sel.querySelector(`option[value="${saved}"]`)) sel.value = saved;
    await refreshSetInfo();
  }
  async function refreshSetInfo(){
    const id = Number(document.getElementById('setSelect').value||'0');
    const j = await fetch('/api/mock-sets').then(r=>r.json());
    const s = (j.sets||[]).find(x=>x.id===id);
    const el = document.getElementById('setInfo');
    if(!s){ el.textContent = 'No files detected yet.'; return; }
    el.innerHTML = `<ul>
      <li>Jobs: ${s.jobs||'<em>missing</em>'}</li>
      <li>Vehicles: ${s.vehicles||'<em>missing</em>'}</li>
      <li>Request: ${s.request||'<em>missing</em>'}</li>
      <li>Response: ${s.response||'<em>missing</em>'}</li>
      <li>Viewer: <a href="${s.viewer_url}">${s.viewer_url}</a></li>
    </ul>`;
  }
  function renderTable(elId, prev){
    const el = document.getElementById(elId);
    const rows = prev?.rows || [];
    el.innerHTML = rows.length ? `<table>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</table>` : '<em>No preview</em>';
  }
  document.getElementById('refreshSets').onclick = loadSets;
  document.getElementById('setSelect').onchange = async () => {
    try{ localStorage.setItem('TT_SET_ID', String(document.getElementById('setSelect').value)); }catch{}
    await refreshSetInfo();
  };
  document.getElementById('uploadBtn').onclick = async () => {
    const id = Number(document.getElementById('setSelect').value||'0');
    if(!id){ alert('Pick an assignment'); return; }
    const jobs = document.getElementById('jobsFile').files[0] || null;
    const vehicles = document.getElementById('vehiclesFile').files[0] || null;
    if(!jobs && !vehicles){ alert('Pick CSV to upload'); return; }
    const fd = new FormData(); if(jobs) fd.append('jobs', jobs); if(vehicles) fd.append('vehicles', vehicles);
    console.log('POST', `/api/mock-sets/${id}/upload`);
    const r = await fetch(`/api/mock-sets/${encodeURIComponent(id)}/upload`, { method:'POST', body: fd });
    const j = await r.json();
    renderTable('jobsPreview', j.preview?.jobs); renderTable('vehiclesPreview', j.preview?.vehicles);
    await refreshSetInfo();
    alert('Upload complete');
  };
  document.getElementById('openViewer').onclick = () => {
    const id = document.getElementById('setSelect').value;
    if(!id) { alert('Pick an assignment'); return; }
    window.location.href = `/viewer?set=${encodeURIComponent(id)}`;
  };
  loadSets();
  </script>
</body>
</html>
